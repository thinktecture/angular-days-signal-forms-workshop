<mat-card class="form-container">
  <mat-card-header>
    <mat-card-title>Signal Forms - Registration (Solution)</mat-card-title>
    <mat-card-subtitle>
      This is the migrated version using Angular Signal Forms API.
      Compare with the original Reactive Form to see the differences.
    </mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <form (ngSubmit)="onSubmit()">
      <!-- Personal Info Section -->
      <section class="form-section">
        <h3>Personal Information</h3>

        <div class="form-row">
          <!-- BEFORE: formControlName="firstName" -->
          <!-- AFTER:  [formField]="registrationForm.firstName" -->
          <mat-form-field appearance="outline">
            <mat-label>First Name</mat-label>
            <input matInput type="text" [formField]="registrationForm.firstName" />
            @if (registrationForm.firstName().invalid() && registrationForm.firstName().touched()) {
              @for (error of registrationForm.firstName().errors(); track error.message) {
                <mat-error>{{ error.message }}</mat-error>
              }
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Last Name</mat-label>
            <input matInput type="text" [formField]="registrationForm.lastName" />
            @if (registrationForm.lastName().invalid() && registrationForm.lastName().touched()) {
              @for (error of registrationForm.lastName().errors(); track error.message) {
                <mat-error>{{ error.message }}</mat-error>
              }
            }
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email</mat-label>
          <input matInput type="email" [formField]="registrationForm.email" />
          @if (registrationForm.email().invalid() && registrationForm.email().touched()) {
            @for (error of registrationForm.email().errors(); track error.message) {
              <mat-error>{{ error.message }}</mat-error>
            }
          }
        </mat-form-field>
      </section>

      <!-- Password Section -->
      <section class="form-section">
        <h3>Password</h3>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Password</mat-label>
          <input matInput type="password" [formField]="registrationForm.password" />
          @if (registrationForm.password().invalid() && registrationForm.password().touched()) {
            @for (error of registrationForm.password().errors(); track error.message) {
              <mat-error>{{ error.message }}</mat-error>
            }
          }
          <!-- Password strength feedback (computed signal) -->
          @if (formModel().password && !passwordStrength().valid) {
            <mat-hint class="password-hint">
              Password must contain: {{ passwordStrength().errors.join(', ') }}
            </mat-hint>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Confirm Password</mat-label>
          <input matInput type="password" [formField]="registrationForm.confirmPassword" />
          @if (registrationForm.confirmPassword().invalid() && registrationForm.confirmPassword().touched()) {
            @for (error of registrationForm.confirmPassword().errors(); track error.message) {
              <mat-error>{{ error.message }}</mat-error>
            }
          }
          <!-- Cross-field validation: password match (computed signal) -->
          @if (!passwordsMatch() && registrationForm.confirmPassword().touched()) {
            <mat-error>Passwords do not match</mat-error>
          }
        </mat-form-field>
      </section>

      <!-- Address Section (Nested Object) -->
      <!-- BEFORE: formGroupName="address" -->
      <!-- AFTER:  Direct access via registrationForm.address.* -->
      <section class="form-section">
        <h3>Address</h3>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Street</mat-label>
          <input matInput type="text" [formField]="registrationForm.address.street" />
          @if (registrationForm.address.street().invalid() && registrationForm.address.street().touched()) {
            @for (error of registrationForm.address.street().errors(); track error.message) {
              <mat-error>{{ error.message }}</mat-error>
            }
          }
        </mat-form-field>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Postal Code</mat-label>
            <input matInput type="text" [formField]="registrationForm.address.postalCode" placeholder="12345" />
            @if (registrationForm.address.postalCode().invalid() && registrationForm.address.postalCode().touched()) {
              @for (error of registrationForm.address.postalCode().errors(); track error.message) {
                <mat-error>{{ error.message }}</mat-error>
              }
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>City</mat-label>
            <input matInput type="text" [formField]="registrationForm.address.city" />
            @if (registrationForm.address.city().invalid() && registrationForm.address.city().touched()) {
              @for (error of registrationForm.address.city().errors(); track error.message) {
                <mat-error>{{ error.message }}</mat-error>
              }
            }
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Country</mat-label>
          <mat-select [formField]="registrationForm.address.country">
            <mat-option value="">Select a country...</mat-option>
            @for (country of countries; track country) {
              <mat-option [value]="country">{{ country }}</mat-option>
            }
          </mat-select>
          @if (registrationForm.address.country().invalid() && registrationForm.address.country().touched()) {
            @for (error of registrationForm.address.country().errors(); track error.message) {
              <mat-error>{{ error.message }}</mat-error>
            }
          }
        </mat-form-field>
      </section>

      <!-- Phone Numbers Section (Array) -->
      <!-- BEFORE: *ngFor with [formGroupName]="i" and formControlName -->
      <!-- AFTER:  @for with registrationForm.phoneNumbers[i].* -->
      <section class="form-section">
        <h3>Phone Numbers</h3>

        @for (phone of formModel().phoneNumbers; track $index; let i = $index) {
          <div class="phone-entry">
            <div class="phone-row">
              <mat-form-field appearance="outline" class="type-field">
                <mat-label>Type</mat-label>
                <mat-select [formField]="registrationForm.phoneNumbers[i].type">
                  @for (type of phoneTypes; track type) {
                    <mat-option [value]="type">{{ type }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="number-field">
                <mat-label>Number</mat-label>
                <input
                  matInput
                  type="tel"
                  [formField]="registrationForm.phoneNumbers[i].number"
                  placeholder="+49 123 456789"
                />
                @if (registrationForm.phoneNumbers[i].number().touched() && !isPhoneNumberValid(phone.number)) {
                  <mat-error>Invalid phone number format</mat-error>
                }
              </mat-form-field>

              <button
                mat-icon-button
                color="warn"
                type="button"
                (click)="removePhoneNumber(i)"
                [disabled]="formModel().phoneNumbers.length === 1"
                aria-label="Remove phone number"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        }

        <button mat-stroked-button color="primary" type="button" (click)="addPhoneNumber()">
          <mat-icon>add</mat-icon>
          Add Phone Number
        </button>
      </section>

      <!-- Terms -->
      <section class="form-section">
        <mat-checkbox [formField]="registrationForm.acceptTerms" color="primary">
          I accept the terms and conditions *
        </mat-checkbox>
        @if (!termsAccepted() && registrationForm.acceptTerms().touched()) {
          <mat-error class="checkbox-error">You must accept the terms</mat-error>
        }
      </section>

      <!-- Form Actions -->
      <!-- BEFORE: [disabled]="registrationForm.invalid" -->
      <!-- AFTER:  [disabled]="!isFormValid() || registrationForm().submitting()" -->
      <div class="form-actions">
        <button mat-flat-button color="primary" type="submit" [disabled]="!isFormValid() || registrationForm().submitting()">
          @if (registrationForm().submitting()) {
            Registering...
          } @else {
            Register
          }
        </button>
        <button mat-stroked-button type="button" (click)="onReset()" [disabled]="registrationForm().submitting()">
          Reset
        </button>
      </div>

      <!-- Processing Error Display -->
      @if (registrationForm().processingError(); as error) {
        <mat-card class="error-banner" appearance="outlined">
          <mat-card-content>
            <strong>Error:</strong> {{ error }}
          </mat-card-content>
        </mat-card>
      }

      <!-- Debug Info -->
      <!-- BEFORE: registrationForm.valid, registrationForm.dirty, registrationForm.value -->
      <!-- AFTER:  registrationForm().valid(), registrationForm().dirty(), formModel() -->
      <mat-card class="debug-info" appearance="outlined">
        <mat-card-header>
          <mat-card-title>Form State (Debug)</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <p><strong>Form Valid:</strong> {{ registrationForm().valid() }}</p>
          <p><strong>Passwords Match:</strong> {{ passwordsMatch() }}</p>
          <p><strong>Terms Accepted:</strong> {{ termsAccepted() }}</p>
          <p><strong>Overall Valid:</strong> {{ isFormValid() }}</p>
          <p><strong>Dirty:</strong> {{ registrationForm().dirty() }}</p>
          <p><strong>Touched:</strong> {{ registrationForm().touched() }}</p>
          <p><strong>Submitting:</strong> {{ registrationForm().submitting() }}</p>
          <h4>Form Value (Signal)</h4>
          <pre>{{ formModel() | json }}</pre>
        </mat-card-content>
      </mat-card>
    </form>
  </mat-card-content>
</mat-card>

@if (submitted()) {
  <mat-card class="success-message">
    <mat-card-header>
      <mat-card-title>Registration Successful!</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <pre>{{ submittedData() | json }}</pre>
    </mat-card-content>
  </mat-card>
}
